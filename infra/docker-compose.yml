services:
    nginx:
        image: nginx:latest
        ports:
            - "8000:80"
        volumes:
            - ../discussion-api:/var/www/html:ro
            - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
        depends_on:
            - discussion-api
            - db

    discussion-api:
        build:
            context: ../discussion-api
            dockerfile: ../infra/php/Dockerfile
        volumes:
            - ../discussion-api:/var/www/html
        environment:
            DATABASE_URL: postgres://postgres:password@db:5432/my_database

    db:
        image: postgres:13
        environment:
            POSTGRES_PASSWORD: password
            POSTGRES_DB: my_database

    gatling:
        image: denvazh/gatling
        platform: linux/amd64
        volumes:
            - ../gatling:/opt/gatling/user-files
        entrypoint: [ "/opt/gatling/bin/gatling.sh", "-s", "simulations.TransferSimulation" ]
        depends_on:
            - nginx
